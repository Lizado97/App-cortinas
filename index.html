    <!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canotex - Sistema de Presupuestos de Cortinas</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .header {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #1e293b;
            font-size: 2rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: #2563eb;
            color: white;
        }

        .btn-primary:hover {
            background: #1d4ed8;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37,99,235,0.3);
        }

        .btn-secondary {
            background: #64748b;
            color: white;
        }

        .btn-secondary:hover {
            background: #475569;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .card {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .card h2 {
            color: #1e293b;
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #475569;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 1rem;
            transition: border 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37,99,235,0.1);
        }

        .grid {
            display: grid;
            gap: 1.5rem;
        }

        .grid-2 {
            grid-template-columns: repeat(2, 1fr);
        }

        .item-list {
            margin-top: 1rem;
        }

        .item {
            background: #f8fafc;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #e2e8f0;
        }

        .item-info {
            flex: 1;
        }

        .item-info h4 {
            color: #1e293b;
            margin-bottom: 0.5rem;
        }

        .item-info p {
            color: #64748b;
            font-size: 0.875rem;
        }

        .item-price {
            font-size: 1.25rem;
            font-weight: bold;
            color: #2563eb;
            margin-right: 1rem;
        }

        .resumen {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            color: white;
            padding: 2rem;
            border-radius: 12px;
            position: sticky;
            top: 2rem;
        }

        .resumen h3 {
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
        }

        .resumen-linea {
            display: flex;
            justify-content: space-between;
            padding: 1rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .resumen-total {
            font-size: 1.75rem;
            font-weight: bold;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 2px solid rgba(255,255,255,0.3);
        }

        .hidden {
            display: none !important;
        }

        .tabla {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .tabla thead {
            background: #f8fafc;
        }

        .tabla th {
            padding: 1rem;
            text-align: left;
            color: #475569;
            font-weight: 600;
            border-bottom: 2px solid #e2e8f0;
        }

        .tabla td {
            padding: 1rem;
            border-bottom: 1px solid #e2e8f0;
            color: #1e293b;
        }

        .tabla tbody tr:hover {
            background: #f8fafc;
            cursor: pointer;
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .badge-borrador {
            background: #e2e8f0;
            color: #475569;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            font-size: 0.875rem;
            opacity: 0.9;
            margin-bottom: 0.5rem;
        }

        .stat-card .value {
            font-size: 2rem;
            font-weight: bold;
        }

        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            margin-top: 1rem;
            border: 1px solid #e2e8f0;
        }

        .checkbox-container input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            flex-shrink: 0;
        }

        .checkbox-container label {
            cursor: pointer;
            margin: 0;
            font-weight: 500;
        }

        .search-box {
            position: relative;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-top: 0.5rem;
        }

        .search-result-item {
            padding: 1rem;
            cursor: pointer;
            border-bottom: 1px solid #e2e8f0;
        }

        .search-result-item:hover {
            background: #f8fafc;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .aviso-orientativo {
            background: #fef3c7;
            border: 2px solid #fbbf24;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            text-align: center;
        }

        .aviso-orientativo strong {
            color: #92400e;
            font-size: 0.875rem;
            display: block;
        }

        .aviso-orientativo p {
            color: #78716c;
            font-size: 0.75rem;
            margin-top: 0.25rem;
        }

        .tabla-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .step-box {
            padding: 1.5rem;
            border-radius: 12px;
            border: 2px solid;
            margin-bottom: 1.5rem;
        }

        .step-blue {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            border-color: #3b82f6;
        }

        .step-purple {
            background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%);
            border-color: #a855f7;
        }

        .step-amber {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-color: #f59e0b;
        }

        .step-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.25rem;
            flex-shrink: 0;
        }

        .step-blue .step-number {
            background: #2563eb;
        }

        .step-purple .step-number {
            background: #9333ea;
        }

        .step-amber .step-number {
            background: #f59e0b;
        }

        .step-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1e293b;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .header {
                flex-direction: column;
                gap: 1rem;
                padding: 1.25rem;
                align-items: stretch;
            }

            .header h1 {
                font-size: 1.25rem;
            }

            .btn {
                padding: 0.625rem 1rem;
                font-size: 0.875rem;
                justify-content: center;
                width: 100%;
            }

            .card {
                padding: 1.25rem;
            }

            .grid-2 {
                grid-template-columns: 1fr;
            }

            .stats {
                grid-template-columns: 1fr;
            }

            .resumen {
                position: static;
                margin-top: 1rem;
            }

            .item {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.75rem;
            }

            .item-price {
                align-self: flex-end;
                margin-right: 0;
            }
        }

        @media print {
            body {
                background: white;
            }
            
            .btn, .hidden-print {
                display: none !important;
            }

            .card {
                box-shadow: none;
                border: 1px solid #e2e8f0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Vista Dashboard -->
        <div id="dashboard-view">
            <div class="header">
                <div>
                    <h1>ü™ü Canotex - Sistema de Presupuestos</h1>
                    <p style="color: #64748b; margin-top: 0.5rem;">Gesti√≥n de presupuestos de cortinas</p>
                </div>
                <button class="btn btn-primary" onclick="mostrarVista('nuevo')">
                    ‚ûï Nuevo Presupuesto
                </button>
            </div>

            <div class="stats">
                <div class="stat-card">
                    <h3>Total Presupuestos</h3>
                    <div class="value" id="total-presupuestos">0</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                    <h3>Importe Total</h3>
                    <div class="value" id="total-importe">0‚Ç¨</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
                    <h3>Este Mes</h3>
                    <div class="value" id="total-mes">0</div>
                </div>
            </div>

            <div class="card">
                <h2>Presupuestos Recientes</h2>
                <div class="tabla-wrapper">
                    <table class="tabla" id="tabla-presupuestos">
                        <thead>
                            <tr>
                                <th>N√∫mero</th>
                                <th>Cliente</th>
                                <th>Fecha</th>
                                <th>Items</th>
                                <th style="text-align: right;">Total</th>
                                <th style="text-align: center;">Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 3rem; color: #64748b;">
                                    No hay presupuestos. ¬°Crea el primero!
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Vista Nuevo Presupuesto -->
        <div id="nuevo-view" class="hidden">
            <div class="header">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <button class="btn btn-secondary" onclick="mostrarVista('dashboard')">
                        ‚Üê Volver
                    </button>
                    <h1>Nuevo Presupuesto</h1>
                </div>
            </div>

            <div class="grid grid-2">
                <div>
                    <div class="card">
                        <h2>Datos del Cliente</h2>
                        <div class="form-group">
                            <label>Nombre del Cliente *</label>
                            <input type="text" id="cliente-nombre" placeholder="Nombre completo">
                        </div>
                        <div class="grid grid-2">
                            <div class="form-group">
                                <label>Tel√©fono</label>
                                <input type="tel" id="cliente-telefono" placeholder="+34 600 000 000">
                            </div>
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" id="cliente-email" placeholder="cliente@email.com">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Direcci√≥n</label>
                            <input type="text" id="cliente-direccion" placeholder="Calle, n√∫mero, ciudad">
                        </div>
                    </div>

                    <div class="card">

                     <h2>üßÆ Calculadora de Cortinas</h2>

<!-- Selector Tradicionales / T√©cnicas -->
<div style="display: flex; gap: 1rem; margin-bottom: 2rem;">
    <button id="btn-tradicionales" type="button" class="btn btn-primary" onclick="cambiarCategoria('tradicionales')" style="flex: 1;">
        ü™ü Cortinas Tradicionales
    </button>
    <button id="btn-tecnicas" type="button" class="btn btn-secondary" onclick="cambiarCategoria('tecnicas')" style="flex: 1;">
        ‚öôÔ∏è Cortinas T√©cnicas
    </button>
</div>

<!-- ========== FORMULARIO TRADICIONALES ========== -->
<div id="form-tradicionales">
    <!-- TODO TU C√ìDIGO ORIGINAL DE TRADICIONALES (los 3 step-box) -->
    <!-- Secci√≥n 1: Tipo y Tejido -->
    <div class="step-box step-blue">
        <div class="step-header">
            <div class="step-number">1</div>
            <div class="step-title">Tipo y Tejido</div>
        </div>
        
        <div class="form-group">
            <label>Tipo de Cortina *</label>
            <select id="tipo-cortina">
                <option value="">Selecciona el tipo...</option>
                <option value="estor_paquetto">Estor Paquetto (sin varillas)</option>
                <option value="estor_plegable">Estor Plegable (con varillas)</option>
                <option value="cortina_onda_perfecta">Cortina Onda Perfecta</option>
                <option value="cortina_fruncida">Cortina Fruncida</option>
                <option value="cortina_plana">Cortina Plana sin Frunce</option>
                <option value="cortina_ollados">Cortina con Ollados</option>
                <option value="cortina_triple_pliegue">Cortina Triple Pliegue</option>
                <option value="cortina_palas">Cortina Palas</option>
                <option value="cortina_plana_doble">Cortina Plana Doble Tejido</option>
                <option value="cortina_plegones">Cortina Plegones</option>
            </select>
        </div>
        
        <div class="form-group">
            <label>Tejido * <small>(Buscar por nombre)</small></label>
            <div class="search-box">
                <input type="text" id="tejido-search" placeholder="Buscar tejido..." oninput="buscarTejido()">
                <div id="search-results" class="search-results hidden"></div>
            </div>
            <input type="hidden" id="tejido">
        </div>
    </div>

    <!-- Secci√≥n 2: Medidas -->
    <div class="step-box step-purple">
        <div class="step-header">
            <div class="step-number">2</div>
            <div class="step-title">üìè Medidas</div>
        </div>
        
        <div class="grid grid-2">
            <div class="form-group">
                <label>Ancho (cm) *</label>
                <input type="number" id="ancho" placeholder="200">
            </div>
            <div class="form-group">
                <label>Alto (cm) *</label>
                <input type="number" id="alto" placeholder="280">
            </div>
        </div>
        
        <div class="checkbox-container">
            <input type="checkbox" id="dos-piezas">
            <label for="dos-piezas">‚úÇÔ∏è Dividir en 2 piezas</label>
        </div>
    </div>

    <!-- Secci√≥n 3: Sistema -->
    <div class="step-box step-amber">
        <div class="step-header">
            <div class="step-number">3</div>
            <div class="step-title">Sistema de Instalaci√≥n</div>
        </div>
        
        <div class="form-group">
            <label>Sistema (opcional)</label>
            <select id="sistema" onchange="mostrarOpcionesBarras()">
                <option value="">Sin sistema</option>
                <option value="barras">Barras</option>
            </select>
        </div>
        
        <div id="opciones-barras" style="display: none;">
            <div class="form-group" id="diametro-container">
                <label>Di√°metro</label>
                <select id="diametro-barra">
                    <option value="">Selecciona...</option>
                    <option value="20">20mm</option>
                    <option value="28">28mm</option>
                </select>
            </div>
            <div class="form-group">
                <label>Medida</label>
                <select id="medida-barra">
                    <option value="">Selecciona...</option>
                    <option value="150">150cm</option>
                    <option value="200">200cm</option>
                    <option value="250">250cm</option>
                    <option value="300">300cm</option>
                </select>
            </div>
        </div>
        
        <div class="checkbox-container">
            <input type="checkbox" id="incluir-instalacion" onchange="actualizarResumen()">
            <label for="incluir-instalacion">üîß Incluir instalaci√≥n</label>
        </div>
    </div>
    
    <button class="btn btn-primary" onclick="agregarItem()" style="width: 100%; padding: 1rem; font-size: 1.1rem;">
        <span id="btn-texto">‚ûï Calcular y Agregar al Presupuesto</span>
    </button>
</div>

<!-- ========== FORMULARIO T√âCNICAS ========== -->
<div id="form-tecnicas" style="display: none;">
    <!-- Selector Enrollable / Vertical -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 2rem;">
        <button id="btn-enrollable" type="button" class="btn btn-primary" onclick="cambiarTipoTecnica('enrollable')">
            üìú Enrollable
        </button>
        <button id="btn-vertical" type="button" class="btn btn-secondary" onclick="cambiarTipoTecnica('vertical')">
            ‚ñ¶ Vertical
        </button>
    </div>

    <!-- ENROLLABLE -->
<div id="form-enrollable" style="display: none;">
        <!-- PASO 1: Tejido y Medidas -->
        <div class="step-box" style="background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); border-color: #22c55e;">
            <div class="step-header">
                <div class="step-number" style="background: #22c55e;">1</div>
                <div class="step-title">Tejido y Medidas</div>
            </div>
            
            <div class="form-group">
                <label>Tipo de Tejido *</label>
                <select id="tejido-enrollable" onchange="actualizarPrecioEnrollable()">
                    <option value="">Selecciona...</option>
                    <option value="THECNIC BASIC">THECNIC BASIC</option>
                    <option value="EFFECTO">EFFECTO / SUPREM / HYBRID / SUPER / VOLGA / NEBULA / TAMESIS</option>
                    <option value="MEGA SOMBRA">MEGA SOMBRA / LIENA</option>
                    <option value="LINEN">LINEN</option>
                    <option value="LIBERTY">LIBERTY (Alba/Bursa/Otoman) / CAPRI / SICORIS / GENTLEMAN</option>
                    <option value="MALLA SARGA">MALLA SARGA / SCREEN CERO</option>
                    <option value="DECOR STYLE">DECOR STYLE</option>
                    <option value="DECOR LINE">DECOR LINE</option>
                    <option value="RIN">RIN / ORINOCO / FEROE</option>
                    <option value="AMAZONAS">AMAZONAS / DANUBIO</option>
                    <option value="BLACK OUT">BLACK OUT / OPAC</option>
                </select>
            </div>
            
            <div class="grid grid-2">
                <div class="form-group">
                    <label>Ancho (cm) *</label>
                    <input type="number" id="ancho-enrollable" placeholder="100" onchange="actualizarPrecioEnrollable()">
                </div>
                <div class="form-group">
                    <label>Alto (cm) *</label>
                    <input type="number" id="alto-enrollable" placeholder="120" onchange="actualizarPrecioEnrollable()">
                </div>
            </div>
        </div>

        <!-- PASO 2: Di√°metro y Configuraci√≥n -->
        <div class="step-box" style="background: linear-gradient(135deg, #ddd6fe 0%, #c4b5fd 100%); border-color: #a855f7;">
            <div class="step-header">
                <div class="step-number" style="background: #a855f7;">2</div>
                <div class="step-title">‚öôÔ∏è Di√°metro y Configuraci√≥n</div>
            </div>
            
            <div class="checkbox-container" style="background: #fef3c7; border: 2px solid #f59e0b;">
                <input type="checkbox" id="motorizado-enrollable" onchange="actualizarDiametrosDisponibles()">
                <label for="motorizado-enrollable">üîå <strong>MOTORIZADO (Somfy)</strong></label>
            </div>
            
            <div class="form-group" style="margin-top: 1rem;">
                <label>Di√°metro del Tubo *</label>
                <select id="diametro-enrollable" onchange="actualizarPrecioEnrollable()">
                    <option value="">Selecciona...</option>
                    <option value="32">Tubo √ò32mm (Manual)</option>
                    <option value="43">Tubo √ò43mm (Manual)</option>
                    <option value="58">Tubo √ò58mm (Manual)</option>
                </select>
            </div>
            
            <div class="grid grid-2">
                <div class="form-group">
                    <label>Posici√≥n del Mando</label>
                    <select id="mando-enrollable">
                        <option value="izquierda">‚¨ÖÔ∏è Izquierda</option>
                        <option value="derecha">‚û°Ô∏è Derecha</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Direcci√≥n de Enrollado</label>
                    <select id="direccion-enrollable">
                        <option value="interior">üè† Interior</option>
                        <option value="exterior">üå§Ô∏è Exterior</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- PASO 3: Accesorios e Instalaci√≥n -->
        <div class="step-box" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-color: #f59e0b;">
            <div class="step-header">
                <div class="step-number" style="background: #f59e0b;">3</div>
                <div class="step-title">üîß Accesorios e Instalaci√≥n</div>
            </div>
            
            <div class="form-group">
                <label>Accesorios Opcionales</label>
                <div id="accesorios-enrollable-list" style="max-height: 250px; overflow-y: auto; border: 1px solid #cbd5e1; border-radius: 8px; padding: 0.5rem;">
                    <!-- Se llena din√°micamente -->
                </div>
            </div>
            
            <div class="checkbox-container">
                <input type="checkbox" id="instalacion-enrollable" onchange="actualizarPrecioEnrollable()">
                <label for="instalacion-enrollable">üîß Incluir instalaci√≥n (+50‚Ç¨)</label>
            </div>
            
            <div style="background: white; padding: 1.5rem; border-radius: 12px; margin-top: 1rem; border: 3px solid #22c55e;">
                <div style="display: flex; justify-content: space-between; font-size: 1.5rem; font-weight: bold;">
                    <span style="color: #1e293b;">PRECIO TOTAL:</span>
                    <span id="precio-enrollable-preview" style="color: #22c55e;">0.00‚Ç¨</span>
                </div>
            </div>
        </div>
        
        <button class="btn btn-primary" onclick="agregarItemEnrollable()" style="width: 100%; padding: 1rem; font-size: 1.1rem; background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);">
            ‚ûï Agregar Enrollable al Presupuesto
        </button>
    </div>

    <!-- VERTICAL (pendiente) -->
    <div id="form-vertical" style="display: none;">
        <div class="step-box" style="background: #f0fdf4; border-color: #22c55e; text-align: center; padding: 3rem;">
            <h3 style="color: #15803d;">üöß Cortinas Verticales</h3>
            <p style="color: #64748b; margin-top: 1rem;">Pr√≥ximamente...</p>
        </div>
    </div>
</div>

                    <div class="card" id="items-card" style="display: none;">
                        <h2>Items del Presupuesto</h2>
                        <div class="item-list" id="items-list"></div>
                    </div>

                    <div class="card">
                        <h2>Notas Adicionales</h2>
                        <div class="form-group">
                            <textarea id="notas" rows="4" placeholder="A√±ade cualquier informaci√≥n adicional..."></textarea>
                        </div>
                    </div>
                </div>

                <div>
                    <div class="resumen">
                        <h3>üì¶ Resumen del Presupuesto</h3>
                        <div class="resumen-linea">
                            <span>Total Items:</span>
                            <span id="total-items">0</span>
                        </div>
                        <div class="resumen-linea">
                            <span>Subtotal (sin IVA):</span>
                            <span id="subtotal">0.00‚Ç¨</span>
                        </div>
                        <div class="resumen-linea" id="instalacion-line" style="display: none;">
                            <span>Instalaci√≥n:</span>
                            <span id="instalacion-precio">0.00‚Ç¨</span>
                        </div>
                        <div class="resumen-linea">
                            <span>IVA (21%):</span>
                            <span id="iva">0.00‚Ç¨</span>
                        </div>
                        <div class="resumen-total">
                            <div style="display: flex; justify-content: space-between;">
                                <span>TOTAL:</span>
                                <span id="total">0.00‚Ç¨</span>
                            </div>
                        </div>
                        <button class="btn" onclick="guardarPresupuesto()" style="width: 100%; background: white; color: #2563eb; margin-top: 2rem; font-weight: bold;">
                            üíæ Guardar Presupuesto
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Vista Detalle Presupuesto -->
        <div id="detalle-view" class="hidden">
            <div class="header hidden-print">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <button class="btn btn-secondary" onclick="mostrarVista('dashboard')">
                        ‚Üê Volver
                    </button>
                    <h1>Detalle del Presupuesto</h1>
                </div>
                <button class="btn btn-primary" onclick="window.print()">
                    üñ®Ô∏è Imprimir
                </button>
            </div>

            <div class="card" id="detalle-content"></div>
        </div>
    </div>

    <script>
            const TEJIDOS = [
            { nombre: "AALBORG 60-61-64", precio: 57.68, ancho: 300, composicion: "53% Pes 47% Li" },
            { nombre: "AALBORG 90-91-94", precio: 57.68, ancho: 300, composicion: "57% Pes 43% Li" },
            { nombre: "ABI", precio: 35.13, ancho: 300, composicion: "100% Pes" },
            { nombre: "ACHIRA", precio: 42.25, ancho: 315, composicion: "100% Pes" },
            { nombre: "AKINA", precio: 59.08, ancho: 280, composicion: "70%CV-30%LI" },
            { nombre: "ALCACERES", precio: 51.45, ancho: 315, composicion: "100% Pes" },
            { nombre: "ALFA", precio: 33.26, ancho: 140, composicion: "100% Pol" },
            { nombre: "ALIDA GRIS", precio: 48.62, ancho: 280, composicion: "70% Alg 30% Pes" },
            { nombre: "ALISHA", precio: 38.12, ancho: 280, composicion: "100% Pes" },
            { nombre: "ALISON", precio: 31.35, ancho: 140, composicion: "100% Pes" },
            { nombre: "AMETISTA", precio: 39.20, ancho: 300, composicion: "100% Pes" },
            { nombre: "ANEKO", precio: 59.08, ancho: 280, composicion: "70%CV-30%LI" },
            { nombre: "ANETO", precio: 38.40, ancho: 300, composicion: "100%Pes" },
            { nombre: "ANOUK GRIS", precio: 48.62, ancho: 280, composicion: "70% Alg 30% Pes" },
            { nombre: "APATITE", precio: 39.20, ancho: 300, composicion: "100% Pes" },
            { nombre: "ARACHOVA", precio: 44.52, ancho: 280, composicion: "60% Pes 20% Co 20% PAN" },
            { nombre: "ARNIKA", precio: 45.36, ancho: 295, composicion: "18%Li 82% Pes" },
            { nombre: "ASA", precio: 50.63, ancho: 310, composicion: "88%PES-12%CO" },
            { nombre: "ASLAN", precio: 35.13, ancho: 300, composicion: "100%Pes" },
            { nombre: "ASPEN BCO/CRUDO", precio: 51.10, ancho: 300, composicion: "50% Pes 50% Li" },
            { nombre: "ASPEN LINO", precio: 51.10, ancho: 300, composicion: "50% Pes 50% Li" },
            { nombre: "ASTIN GRIS", precio: 48.62, ancho: 280, composicion: "70% Alg 30% Pes" },
            { nombre: "ASTRID", precio: 38.12, ancho: 280, composicion: "100% Pes" },
            { nombre: "ASTUN", precio: 33.41, ancho: 300, composicion: "50% Pes 50% Li" },
            { nombre: "AZAD", precio: 35.13, ancho: 300, composicion: "80% Pes 20% Li" },
            { nombre: "AZAMI", precio: 59.08, ancho: 280, composicion: "70%CV-30%LI" },
            { nombre: "BAMBERG", precio: 48.72, ancho: 140, composicion: "100% Pol" },
            { nombre: "BAVAY", precio: 51.10, ancho: 300, composicion: "50% Pes 50% Li" },
            { nombre: "BEGUR", precio: 45.68, ancho: 300, composicion: "60% Pes 40% Li" },
            { nombre: "BERLIN", precio: 31.40, ancho: 140, composicion: "100% Pes" },
            { nombre: "BETA", precio: 33.26, ancho: 140, composicion: "100% Pol" },
            { nombre: "BIBLOS", precio: 37.52, ancho: 300, composicion: "80% Pes 20% Li" },
            { nombre: "BINDY", precio: 54.99, ancho: 310, composicion: "62%PES-38%PAN" },
            { nombre: "BLITZ", precio: 54.88, ancho: 300, composicion: "58% Pes 42% Li" },
            { nombre: "BOLLY", precio: 35.46, ancho: 310, composicion: "95%PES-5%CO" },
            { nombre: "BONIFACIO", precio: 45.68, ancho: 300, composicion: "60% Pes 40% Li" },
            { nombre: "BONN", precio: 48.72, ancho: 140, composicion: "8% Li 92% Pes" },
            { nombre: "BREMEN", precio: 42.33, ancho: 140, composicion: "100% Pol" },
            { nombre: "BRERA", precio: 42.53, ancho: 300, composicion: "50% Pes 50% Li" },
            { nombre: "BRISA", precio: 64.68, ancho: 310, composicion: "97%PES 3%CO" },
            { nombre: "BUBBLES", precio: 48.56, ancho: 280, composicion: "50% Pes 50% Co" },
            { nombre: "CALVI", precio: 42.53, ancho: 300, composicion: "50% Li 50% Pes" },
            { nombre: "CANNES", precio: 35.96, ancho: 140, composicion: "100% Pes" },
            { nombre: "CANVAS", precio: 59.22, ancho: 310, composicion: "50 % Li 50 % Co" },
            { nombre: "CARLOTA", precio: 40.70, ancho: 300, composicion: "100% Pes" },
            { nombre: "CASSIS", precio: 36.57, ancho: 300, composicion: "50% Li 50% Pes" },
            { nombre: "CATIONIC PLANA", precio: 42.57, ancho: 300, composicion: "100% Pol" },
            { nombre: "CATIONIC SARGA", precio: 42.57, ancho: 300, composicion: "100% Pol" },
            { nombre: "CHATEAU", precio: 51.45, ancho: 310, composicion: "100% Pes" },
            { nombre: "CIARA", precio: 50.63, ancho: 310, composicion: "88%PES-12%CO" },
            { nombre: "CIVITA", precio: 48.58, ancho: 300, composicion: "28% Pes 60% Co 12% Li" },
            { nombre: "COLONIA", precio: 31.40, ancho: 140, composicion: "100% Pes" },
            { nombre: "CONCHA", precio: 41.11, ancho: 300, composicion: "70% Pol 30% Li" },
            { nombre: "COSAMOC", precio: 55.48, ancho: 280, composicion: "45% Pes 52% Alg 3% Li" },
            { nombre: "COTICA", precio: 55.48, ancho: 280, composicion: "45% Pes 52% Alg 3% Li" },
            { nombre: "DESIGN", precio: 52.07, ancho: 280, composicion: "40% Pes 40% Co 20% Pac" },
            { nombre: "DEVA", precio: 116.98, ancho: 300, composicion: "43%LI-40%CV-17%WO" },
            { nombre: "DIAMANTE", precio: 39.20, ancho: 300, composicion: "9 % Acr 91 % Pes" },
            { nombre: "DILARA", precio: 39.06, ancho: 300, composicion: "100% Pes" },
            { nombre: "DORTMUND", precio: 42.33, ancho: 140, composicion: "100% Pol" },
            { nombre: "DRESDEN", precio: 48.72, ancho: 140, composicion: "42% Acr 58% Pes" },
            { nombre: "ELISE BCO/CRUDO", precio: 33.40, ancho: 300, composicion: "50% Pes 50% Li" },
            { nombre: "ELISE LINO", precio: 33.40, ancho: 300, composicion: "50% Pes 50% Li" },
            { nombre: "ELMA", precio: 41.58, ancho: 300, composicion: "100% Pes" },
            { nombre: "ENDER", precio: 39.06, ancho: 300, composicion: "100% Pes" },
            { nombre: "ESPIGA", precio: 52.70, ancho: 280, composicion: "65% Pes 35% Co" },
            { nombre: "EWAN", precio: 31.35, ancho: 140, composicion: "100% Pes" },
            { nombre: "FLAT", precio: 34.24, ancho: 140, composicion: "100% Pes" },
            { nombre: "FLIEDER", precio: 73.50, ancho: 290, composicion: "60% CV 25% Li 15% Pes" },
            { nombre: "FLORAL", precio: 52.70, ancho: 280, composicion: "65% Pes 35% Co" },
            { nombre: "FORNELLS", precio: 41.11, ancho: 300, composicion: "65% Pol 35% Li" },
            { nombre: "FUJI", precio: 59.08, ancho: 280, composicion: "70%CV-30%LI" },
            { nombre: "GAMMA", precio: 33.26, ancho: 140, composicion: "100% Pol" },
            { nombre: "GEN", precio: 50.63, ancho: 300, composicion: "100% PES" },
            { nombre: "GINEBRA", precio: 40.70, ancho: 300, composicion: "100% Pes" },
            { nombre: "GLAT", precio: 47.31, ancho: 315, composicion: "100% Pes Ignifugo" },
            { nombre: "GORBEA", precio: 35.12, ancho: 300, composicion: "100%Pes" },
            { nombre: "HAMLET", precio: 38.12, ancho: 280, composicion: "100% Pes" },
            { nombre: "HANOVER", precio: 31.40, ancho: 140, composicion: "100% Pes" },
            { nombre: "HYDRA", precio: 44.52, ancho: 280, composicion: "60% Pes 20% Co 20% PAN" },
            { nombre: "IBOR", precio: 42.15, ancho: 140, composicion: "56% Alg 4% Li 12% Pol 28% Acr" },
            { nombre: "IMA", precio: 59.08, ancho: 280, composicion: "70%CV-30%LI" },
            { nombre: "INDIRA", precio: 38.12, ancho: 280, composicion: "100% Pes" },
            { nombre: "JANIN", precio: 50.04, ancho: 300, composicion: "66%PES-34%CV" },
            { nombre: "JIN", precio: 59.08, ancho: 280, composicion: "70%CV-30%LI" },
            { nombre: "KALIA", precio: 38.12, ancho: 280, composicion: "100% Pes" },
            { nombre: "KAMILLE", precio: 36.10, ancho: 305, composicion: "100% Pes" },
            { nombre: "KATY", precio: 50.04, ancho: 300, composicion: "78%PES-22%LI" },
            { nombre: "KEIKO", precio: 59.08, ancho: 280, composicion: "70%CV-30%LI" },
            { nombre: "KEREN", precio: 35.13, ancho: 300, composicion: "100% Pes" },
            { nombre: "KHAN", precio: 35.13, ancho: 290, composicion: "92% Pes 8% Cv" },
            { nombre: "KIMI", precio: 59.08, ancho: 280, composicion: "70%CV-30%LI" },
            { nombre: "KURVEN", precio: 122.75, ancho: 275, composicion: "100 % Li" },
            { nombre: "LEGI", precio: 38.12, ancho: 280, composicion: "100% Pes" },
            { nombre: "LIMENI", precio: 44.52, ancho: 280, composicion: "60% CV 25% Li 15% Pes" },
            { nombre: "LINDAU", precio: 42.33, ancho: 140, composicion: "100% Pol" },
            { nombre: "LINE", precio: 47.31, ancho: 315, composicion: "100% Pes Ignifugo" },
            { nombre: "LINETTE BLACKOUT", precio: 66.08, ancho: 290, composicion: "Blackout" },
            { nombre: "LINSE", precio: 61.66, ancho: 290, composicion: "60% CV 25% Li 15% Pes" },
            { nombre: "LOCA", precio: 50.04, ancho: 280, composicion: "90%CV- 10%PES" },
            { nombre: "LOGAN", precio: 31.35, ancho: 140, composicion: "100% Pes" },
            { nombre: "LOIRA", precio: 49.65, ancho: 320, composicion: "100% Pol" },
            { nombre: "LOUTROS", precio: 44.52, ancho: 280, composicion: "60% Pes 20% Co 20% PAN" },
            { nombre: "LUBECA", precio: 42.33, ancho: 140, composicion: "100% Pol" },
            { nombre: "LULI", precio: 50.04, ancho: 300, composicion: "100% PES" },
            { nombre: "LUZZI", precio: 47.63, ancho: 300, composicion: "80% Pes 20% Li" },
            { nombre: "MALADETA", precio: 36.23, ancho: 300, composicion: "100%Pes" },
            { nombre: "MATI", precio: 38.12, ancho: 280, composicion: "100% Pes" },
            { nombre: "MAVI", precio: 44.66, ancho: 300, composicion: "94% Pes 4% Co 2% Li" },
            { nombre: "MEISSEN", precio: 42.33, ancho: 140, composicion: "100% Pol" },
            { nombre: "MENTON", precio: 51.10, ancho: 300, composicion: "50% Li 50% Pes" },
            { nombre: "MERON", precio: 41.11, ancho: 300, composicion: "70% Pol 30% Li" },
            { nombre: "MESH", precio: 89.60, ancho: 300, composicion: "52% Li 48% Pes" },
            { nombre: "MESQUIDA", precio: 45.27, ancho: 300, composicion: "60% Pol 40% Li" },
            { nombre: "MIDORI", precio: 59.08, ancho: 280, composicion: "70%CV-30%LI" },
            { nombre: "MIKA", precio: 59.08, ancho: 280, composicion: "70%CV-30%LI" },
            { nombre: "MILAN BCO/CRUDO", precio: 45.68, ancho: 300, composicion: "60% Pes 40% Li" },
            { nombre: "MOIRA", precio: 31.35, ancho: 140, composicion: "100% Pes" },
            { nombre: "MONET", precio: 56.70, ancho: 300, composicion: "3% Li 97% Pes" },
            { nombre: "MONSUL", precio: 41.11, ancho: 300, composicion: "90% Pol 10% Li" },
            { nombre: "MOOT", precio: 60.38, ancho: 280, composicion: "50% Li 30% Co 20% Pes" },
            { nombre: "MORITZ", precio: 36.57, ancho: 300, composicion: "50% Pes 50% Li" },
            { nombre: "MULHACEN", precio: 38.40, ancho: 300, composicion: "100%Pes" },
            { nombre: "MULIAN", precio: 38.12, ancho: 280, composicion: "100% Pes" },
            { nombre: "MUNICH", precio: 31.40, ancho: 140, composicion: "100% Pes" },
            { nombre: "NAOKO", precio: 59.08, ancho: 280, composicion: "70%CV-30%LI" },
            { nombre: "NAPOLES", precio: 41.58, ancho: 280, composicion: "40% Pes 30% Pan 30% Co" },
            { nombre: "NARA", precio: 59.08, ancho: 280, composicion: "70%CV-30%LI" },
            { nombre: "NAUPLIA", precio: 44.52, ancho: 280, composicion: "60% Pes 20% Co 20% PAN" },
            { nombre: "NELKE", precio: 60.62, ancho: 290, composicion: "60% CV 25% Li 15% Pes" },
            { nombre: "NEUTRA", precio: 33.40, ancho: 300, composicion: "50% Pes 50% Li" },
            { nombre: "NEYLAN", precio: 35.13, ancho: 300, composicion: "100% Pes" },
            { nombre: "NICE", precio: 34.24, ancho: 140, composicion: "100% Pes" },
            { nombre: "NIKI", precio: 50.04, ancho: 280, composicion: "90%CV- 10%PES" },
            { nombre: "NOGALES", precio: 51.35, ancho: 310, composicion: "100% Li" },
            { nombre: "NOMI", precio: 54.04, ancho: 280, composicion: "70%CV-30%LI" },
            { nombre: "OMEGA", precio: 33.26, ancho: 140, composicion: "100% Pol" },
            { nombre: "ONDAS", precio: 52.70, ancho: 280, composicion: "65% Pes 35% Co" },
            { nombre: "ONUR", precio: 46.89, ancho: 315, composicion: "53% Pan 47% Pes" },
            { nombre: "OPERA", precio: 93.83, ancho: 310, composicion: "100% Li" },
            { nombre: "ORZAN", precio: 44.43, ancho: 300, composicion: "70% Pol 30% Li" },
            { nombre: "PAINE", precio: 47.60, ancho: 280, composicion: "100% Pes" },
            { nombre: "PALOMA", precio: 45.37, ancho: 320, composicion: "35% Pol 65% Li" },
            { nombre: "PANDORA", precio: 50.04, ancho: 300, composicion: "90%CV- 10%PES" },
            { nombre: "PAPAGAYO", precio: 41.11, ancho: 300, composicion: "80% Pol 20% Li" },
            { nombre: "PAPINGO", precio: 44.52, ancho: 280, composicion: "60% Pes 20% Co 20% PAN" },
            { nombre: "PERDI", precio: 40.06, ancho: 310, composicion: "77%PAN-20%PES-3%PA" },
            { nombre: "PLAIN", precio: 62.86, ancho: 280, composicion: "65% Li 25% Co 10% Pes" },
            { nombre: "POINT", precio: 37.32, ancho: 140, composicion: "100% Pes" },
            { nombre: "PROVENCAL AZUL", precio: 48.62, ancho: 280, composicion: "70% Alg 30% Pes" },
            { nombre: "PROVENCAL GRIS", precio: 48.62, ancho: 280, composicion: "70% Alg 30% Pes" },
            { nombre: "PROVENCAL ROJO", precio: 48.62, ancho: 280, composicion: "70% Alg 30% Pes" },
            { nombre: "PUNKE", precio: 47.31, ancho: 315, composicion: "100% Pes Ignifugo" },
            { nombre: "RACK", precio: 25.34, ancho: 300, composicion: "100% Pes" },
            { nombre: "RALPH BCO/CRUDO", precio: 68.40, ancho: 300, composicion: "50% Pes 50% Li" },
            { nombre: "RALPH LINO", precio: 70.59, ancho: 300, composicion: "50% Pes 50% Li" },
            { nombre: "RATISBONA", precio: 42.33, ancho: 140, composicion: "100% Pol" },
            { nombre: "RAU", precio: 50.12, ancho: 280, composicion: "75% Co 25% Pes" },
            { nombre: "REINA", precio: 74.94, ancho: 315, composicion: "94%PES- 6%CV" },
            { nombre: "RETINO", precio: 44.52, ancho: 280, composicion: "60% Pes 20% Co 20% PAN" },
            { nombre: "ROMA", precio: 41.58, ancho: 280, composicion: "40% Pes 30% Pan 30% Co" },
            { nombre: "ROMBO", precio: 52.70, ancho: 280, composicion: "65% Pes 35% Co" },
            { nombre: "ROMBUS", precio: 100.38, ancho: 290, composicion: "100 % Li" },
            { nombre: "RUBINO", precio: 39.20, ancho: 300, composicion: "100% Pes" },
            { nombre: "SALADA", precio: 44.43, ancho: 320, composicion: "60% Pol 40% Li" },
            { nombre: "SAONA", precio: 41.11, ancho: 300, composicion: "80% Pol 20% Li" },
            { nombre: "SAURA", precio: 41.11, ancho: 295, composicion: "85% Pol 15% Li" },
            { nombre: "SCOTT", precio: 31.35, ancho: 140, composicion: "100% Pes" },
            { nombre: "SELIN", precio: 35.13, ancho: 300, composicion: "80% Pes 20% Li" },
            { nombre: "SHIELD", precio: 60.38, ancho: 280, composicion: "50% Li 30% Co 20% Pes" },
            { nombre: "SISUCA", precio: 48.27, ancho: 310, composicion: "67%PAN-26%PES-7%PA" },
            { nombre: "SMERALDO", precio: 40.93, ancho: 300, composicion: "100% Pes" },
            { nombre: "SMOOTH", precio: 88.20, ancho: 280, composicion: "100 % Li" },
            { nombre: "SOFT", precio: 54.68, ancho: 310, composicion: "77% Trev 23% Pes" },
            { nombre: "SOTAVENTO", precio: 41.11, ancho: 315, composicion: "80% Pol 20% Li" },
            { nombre: "STAR", precio: 48.56, ancho: 280, composicion: "50% Pes 50% Co" },
            { nombre: "STICK", precio: 48.56, ancho: 280, composicion: "50% Pes 50% Co" },
            { nombre: "STILO", precio: 68.65, ancho: 295, composicion: "80% Vis 20% Li" },
            { nombre: "STUTGART", precio: 39.20, ancho: 140, composicion: "100% Pol" },
            { nombre: "SWEET", precio: 25.34, ancho: 310, composicion: "100 % Pes ignifug" },
            { nombre: "SYMI", precio: 44.52, ancho: 280, composicion: "60% Pes 20% Co 20% PAN" },
            { nombre: "TANG", precio: 78.68, ancho: 290, composicion: "55% Li 30% Co 20% Pes" },
            { nombre: "TEIDE", precio: 36.23, ancho: 300, composicion: "100%Pes" },
            { nombre: "TERA", precio: 42.15, ancho: 140, composicion: "56% Alg 4% Li 12% Pol 28% Acr" },
            { nombre: "TERESITAS", precio: 44.43, ancho: 320, composicion: "60% Pol 40% Li" },
            { nombre: "TIM", precio: 57.26, ancho: 290, composicion: "65% Li 25% Co 10% Pes" },
            { nombre: "TORTORA", precio: 45.89, ancho: 310, composicion: "60%PES-40%LI" },
            { nombre: "TRAUBE", precio: 73.50, ancho: 290, composicion: "60% CV 25% Li 15% Pes" },
            { nombre: "TRAUM", precio: 71.37, ancho: 290, composicion: "100% Li" },
            { nombre: "TREVERIS", precio: 48.32, ancho: 140, composicion: "5% Li 95% Pes" },
            { nombre: "VELLUTO", precio: 48.51, ancho: 280, composicion: "100% Pes" },
            { nombre: "VENECIA", precio: 41.58, ancho: 280, composicion: "40% Pes 30% Pan 30% Co" },
            { nombre: "XARCO", precio: 32.79, ancho: 350, composicion: "90% Pol 10% Li" },
            { nombre: "YECLA 01-02-03", precio: 47.88, ancho: 300, composicion: "50% Pes 50% Li" },
            { nombre: "YECLA 11-12-13", precio: 47.88, ancho: 300, composicion: "50% Pes 50% Li" },
            { nombre: "YECLA 41-42-43", precio: 47.88, ancho: 310, composicion: "50% Pes 50% Li" },
            { nombre: "YECLA 51-52-53", precio: 47.88, ancho: 300, composicion: "50% Pes 50% Li" },
            { nombre: "ZAHARA", precio: 41.11, ancho: 300, composicion: "90% Pol 10% Li" }
        ];
        
        
         const TEJIDOS_ENROLLABLES = [
    "THECNIC BASIC",
    "EFFECTO Cristal-Fantasia",
    "SUPREM Helios",
    "HYBRID Zafiro",
    "SUPER Nilo",
    "VOLGA",
    "NEBULA",
    "TAMESIS",
    "MEGA SOMBRA",
    "LIENA",
    "LINEN",
    "LIBERTY Alba",
    "LIBERTY Bursa",
    "LIBERTY Otoman",
    "CAPRI",
    "SICORIS",
    "GENTLEMAN Dark",
    "MALLA SARGA",
    "SCREEN CERO",
    "DECOR STYLE",
    "DECOR LINE",
    "RIN",
    "ORINOCO",
    "FEROE",
    "AMAZONAS",
    "DANUBIO",
    "BLACK OUT",
    "OPAC"
];

        
                   // SISTEMA SIMPLY √ò32 (MANUAL)
            const ENROLLABLE_32_MANUAL = {
                "THECNIC BASIC": {70:{100:99.54,120:103.13,140:106.72,160:110.31,180:113.90,200:117.49,220:121.08,240:124.67},90:{100:111.39,120:116.00,140:120.62,160:125.23,180:129.85,200:134.46,220:139.08,240:143.70},110:{100:119.44,120:125.08,140:130.72,160:136.36,180:142.00,200:147.64,220:153.29,240:158.93},130:{100:129.39,120:136.05,140:142.72,160:149.39,180:156.05,200:162.72,220:169.39,240:176.05},160:{100:144.31,120:152.52,140:160.72,160:168.93,180:177.13,200:185.34,220:193.54,240:201.75}},
                "EFFECTO": {70:{100:106.86,120:111.67,140:116.49,160:121.30,180:126.11,200:130.92,220:135.73,240:140.54},90:{100:120.80,120:126.99,140:133.17,160:139.36,180:145.54,200:151.73,220:157.91,240:164.10},110:{100:130.95,120:138.51,140:146.06,160:153.62,180:161.18,200:168.74,220:176.30,240:183.86},130:{100:142.99,120:151.92,140:160.85,160:169.79,180:178.72,200:187.65,220:196.59,240:205.52},160:{100:161.05,120:172.04,140:183.04,160:194.03,180:205.03,200:216.02,220:227.02,240:238.01}},
                "MEGA SOMBRA": {70:{100:106.86,120:111.67,140:116.49,160:121.30,180:126.11,200:130.92},90:{100:120.80,120:126.99,140:133.17,160:139.36,180:145.54,200:151.73},110:{100:130.95,120:138.51,140:146.06,160:153.62,180:161.18,200:168.74},130:{100:142.99,120:151.92,140:160.85,160:169.79,180:178.72,200:187.65},160:{100:161.05,120:172.04,140:183.04,160:194.03,180:205.03,200:216.02}},
                "LINEN": {70:{100:118.25,120:123.72,140:129.18,160:134.65,180:140.11,200:145.58,220:151.04,240:156.50},90:{100:134.21,120:141.23,140:148.26,160:155.28,180:162.31,200:169.34,220:176.36,240:183.39},110:{100:145.77,120:154.36,140:162.94,160:171.53,180:180.12,200:188.71,220:197.29,240:205.88},130:{100:159.53,120:169.68,140:179.83,160:189.97,180:200.12,200:210.27,220:220.42,240:230.57},160:{100:180.17,120:192.66,140:205.15,160:217.64,180:230.13,200:242.62,220:255.11,240:267.60}},
                "LIBERTY": {70:{100:105.76,120:109.35,140:112.94,160:116.53,180:120.12,200:123.71,220:127.30,240:130.89},90:{100:117.60,120:122.22,140:126.83,160:131.45,180:136.07,200:140.68,220:145.30,240:149.91},110:{100:125.65,120:131.30,140:136.94,160:142.58,180:148.22,200:153.86,220:159.50,240:165.14},130:{100:135.60,120:142.27,140:148.94,160:155.60,180:162.27,200:168.94,220:175.60,240:182.27},160:{100:150.53,120:158.73,140:166.94,160:175.14,180:183.35,200:191.55,220:199.76,240:207.96}},
                "MALLA SARGA": {70:{100:112.46,120:118.21,140:123.95,160:129.70,180:135.44,200:141.18},90:{100:128.00,120:135.39,140:142.77,160:150.16,180:157.54,200:164.93},110:{100:139.75,120:148.77,140:157.80,160:166.82,180:175.85,200:184.87},130:{100:153.39,120:164.05,140:174.72,160:185.39,180:196.05,200:206.72},160:{100:173.85,120:186.98,140:200.11,160:213.23,180:226.36,200:239.49}},
                "DECOR STYLE": {70:{100:138.70,120:146.08,140:153.47,160:160.83,180:168.22,200:175.60,220:182.99,240:190.37},90:{100:158.24,120:167.72,140:177.23,160:186.70,180:196.21,200:205.70,220:215.19,240:224.69},110:{100:173.19,120:184.79,140:196.39,160:208.00,180:219.60,200:231.20,220:242.82,240:254.41},130:{100:190.44,120:204.16,140:217.87,160:231.59,180:245.29,200:259.01,220:258.72,240:286.43},160:{100:216.31,120:233.18,140:250.07,160:266.94,180:283.82,200:300.71,220:317.58,240:334.46}},
                "DECOR LINE": {70:{100:162.15,120:173.43,140:184.72,160:196.00,180:207.31,200:218.60},90:{100:188.41,120:202.93,140:217.45,160:231.94,180:246.46,200:260.97},110:{100:210.03,120:227.78,140:245.53,160:263.28,180:281.04,200:298.77},130:{100:233.98,120:254.97,140:275.95,160:296.88,180:317.88,200:338.87},160:{100:269.93,120:295.74,140:321.54,160:347.37,180:373.17,200:399.00}},
                "RIN": {70:{100:126.00,120:133.76,140:141.51,160:149.26,180:157.02,200:164.77,220:172.53,240:180.28},90:{100:136.34,120:144.96,140:153.57,160:162.19,180:170.80,200:179.42,220:188.03,240:196.65},110:{100:150.99,120:161.76,140:172.53,160:183.30,180:194.06,200:204.83,220:215.60,240:226.37},130:{100:182.86,120:198.37,140:213.88,160:229.39,180:244.90,200:260.40,220:275.91,240:291.42},160:{100:213.88,120:233.70,140:253.51,160:273.33,180:293.14,200:312.96,220:332.77,240:352.59}},
                "AMAZONAS": {70:{100:155.08,120:159.70,140:171.70,160:183.70,180:195.70,200:207.70,220:219.70,240:231.70},90:{100:168.65,120:173.95,140:187.28,160:200.62,180:213.95,200:227.28,220:240.62,240:253.95},110:{100:191.37,120:198.93,140:215.59,160:232.26,180:248.93,200:265.59,220:282.26,240:298.93},130:{100:241.02,120:253.54,140:277.54,160:301.54,180:325.54,200:349.54,220:373.54,240:397.54},160:{100:288.19,120:305.13,140:335.80,160:366.46,180:397.13,200:427.80,220:458.46,240:489.13}},
                "BLACK OUT": {70:{100:106.86,120:111.67,140:116.49,160:121.30,180:126.11,200:130.92,220:135.73,240:140.54},90:{100:120.80,120:126.99,140:133.17,160:139.36,180:145.54,200:151.73,220:157.91,240:164.10},110:{100:130.95,120:138.51,140:146.06,160:153.62,180:161.18,200:168.74,220:176.30,240:183.86},130:{100:142.99,120:151.92,140:160.85,160:169.79,180:178.72,200:187.65,220:196.59,240:205.52},160:{100:161.05,120:172.04,140:183.04,160:194.03,180:205.03,200:216.02,220:227.02,240:238.01}}
            };
            
            // SISTEMA MEDIUM √ò43 (MANUAL)
            const ENROLLABLE_43_MANUAL = {
                "THECNIC BASIC": {90:{100:120.19,120:124.67,140:129.14,160:133.62,180:138.09,200:142.57,220:147.05,240:151.52,260:156.00,275:160.47,300:177.65,325:184.58},110:{100:130.14,120:135.61,140:141.08,160:146.55,180:152.02,200:157.49,220:162.96,240:168.43,260:173.90,275:179.37,300:198.68,325:207.14},140:{100:145.06,120:152.02,140:158.98,160:165.94,180:172.90,200:179.87,220:186.83,240:193.79,260:200.75,275:207.71,300:230.22,325:240.99},160:{100:155.00,120:162.96,140:170.92,160:178.87,180:186.83,200:194.78,220:202.74,240:210.70,260:218.65,275:226.61,300:284.15,325:296.83},190:{100:169.92,120:179.37,140:188.82,160:198.27,180:207.71,200:217.16,220:226.61,240:236.06,260:258.91,275:295.37},220:{100:184.84,120:195.78,140:206.72,160:217.66,180:228.60,200:239.54,220:264.19,240:275.82,260:313.86,275:325.48},240:{100:197.77,120:210.20,140:222.63,160:235.06,180:247.50,200:274.23,220:287.44,240:300.65,260:340.28,275:353.49}},
                "LINEN": {90:{100:160.36,120:167.94,140:175.52,160:183.09,180:190.67,200:198.25,220:205.82,240:213.40,260:220.97,275:228.55},110:{100:181.53,120:190.76,140:199.99,160:209.22,180:218.45,200:227.68,220:236.91,240:246.14,260:255.37,275:264.60},140:{100:208.24,120:220.16,140:232.08,160:244.00,180:255.92,200:267.84,220:279.76,240:291.68,260:303.60,275:315.52},160:{100:228.78,120:242.78,140:256.78,160:270.78,180:284.78,200:298.78,220:312.78,240:326.78,260:340.78,275:354.78},190:{100:258.30,120:275.43,140:292.56,160:309.69,180:326.82,200:343.95,220:361.08,240:378.21,260:395.34,275:412.47}}
            };
            
            // SISTEMA MEDIUM √ò43 (MANUAL) - m√°s anchos disponibles
            const ENROLLABLE_43_MANUAL = {
                "THECNIC BASIC": {90:{100:120.19,120:124.67,140:129.14,160:133.62,180:138.09,200:142.57,220:147.05,240:151.52,260:156.00,275:160.47,300:177.65},110:{100:130.14,120:135.61,140:141.08,160:146.55,180:152.02,200:157.49,220:162.96,240:168.43,260:173.90,275:179.37},140:{100:145.06,120:152.02,140:158.98,160:165.94,180:172.90,200:179.87,220:186.83,240:193.79,260:200.75,275:207.71},160:{100:155.00,120:162.96,140:170.92,160:178.87,180:186.83,200:194.78,220:202.74,240:210.70,260:218.65,275:226.61},190:{100:169.92,120:179.37,140:188.82,160:198.27,180:207.71,200:217.16,220:226.61,240:236.06,260:258.91,275:295.37},220:{100:184.84,120:195.78,140:206.72,160:217.66,180:228.60,200:239.54,220:264.19,240:275.82,260:313.86,275:325.48},240:{100:197.77,120:210.20,140:222.63,160:235.06,180:247.50,200:274.23,220:287.44,240:300.65,260:340.28,275:353.49}},
                "LINEN": {90:{100:160.36,120:167.94,140:175.52,160:183.09,180:190.67,200:198.25,220:205.82,240:213.40},110:{100:181.53,120:190.76,140:199.99,160:209.22,180:218.45,200:227.68,220:236.91,240:246.14},140:{100:208.24,120:220.16,140:232.08,160:244.00,180:255.92,200:267.84,220:279.76,240:291.68},160:{100:228.78,120:242.78,140:256.78,160:270.78,180:284.78,200:298.78,220:312.78,240:326.78},190:{100:258.30,120:275.43,140:292.56,160:309.69,180:326.82,200:343.95,220:361.08,240:378.21}}
            };
            
            // SISTEMA MEDIUM PLUS √ò58 (MANUAL) - anchos mayores
            const ENROLLABLE_58_MANUAL = {
                "THECNIC BASIC": {90:{100:173.93,120:178.46,140:182.99,160:187.52,180:192.05,200:196.58,220:201.12,240:205.65,260:210.18,275:214.71,300:224.63},110:{100:186.31,120:191.85,140:197.39,160:202.93,180:208.47,200:214.01,220:219.54,240:225.08,260:230.62,275:236.16,300:248.02},140:{100:204.89,120:211.94,140:218.99,160:226.04,180:233.09,200:240.14,220:247.19,240:254.23,260:261.28,275:268.33,300:283.09},160:{100:217.28,120:225.33,140:233.39,160:241.45,180:249.50,200:257.56,220:265.61,240:273.67,260:281.73,275:289.78,300:355.19},190:{100:235.86,120:245.42,140:254.99,160:264.56,180:274.12,200:283.69,220:293.26,240:302.82,260:325.21,275:366.95},210:{100:248.24,120:258.82,140:269.39,160:279.96,180:290.54,200:298.04,220:308.49,240:335.56,260:378.36,275:389.45},230:{100:260.63,120:272.21,140:283.79,160:295.37,180:306.95,200:331.65,220:343.80,240:355.96,260:399.81,275:411.96}}
            };
            
            // MOTORIZADOS √ò43
            const ENROLLABLE_43_MOTOR = {
                "THECNIC BASIC": {90:{100:568.74,120:573.87,140:579.01,160:584.15,180:589.29,200:594.42,220:599.56,240:604.70,260:609.83,275:614.97,300:622.68},110:{100:579.89,120:586.17,140:592.45,160:598.73,180:605.01,200:611.29,220:617.57,240:623.84,260:630.12,275:636.40,300:645.82},140:{100:596.63,120:604.62,140:612.61,160:620.60,180:628.59,200:636.58,220:644.57,240:652.57,260:660.56,275:668.55,300:680.53},160:{100:607.79,120:616.92,140:626.05,160:635.18,180:644.32,200:653.45,220:662.58,240:671.71,260:680.85,275:689.98,300:703.68},190:{100:624.52,120:635.37,140:646.21,160:657.06,180:667.90,200:678.75,220:689.59,240:700.43,260:711.28,275:722.12,300:738.39},220:{100:641.26,120:653.81,140:666.37,160:678.93,180:691.49,200:704.04,220:716.60,240:729.16,260:741.71,275:754.27,300:773.11},240:{100:654.57,120:668.27,140:681.97,160:695.66,180:709.36,200:723.06,220:736.76,240:750.46,260:764.16,275:777.85,300:798.40}},
                "LINEN": {90:{100:645.66,120:653.80,140:661.94,160:670.07,180:678.21,200:686.35,220:694.48,240:702.62,260:710.76,275:718.89,300:731.10},110:{100:661.54,120:671.48,140:681.42,160:691.37,180:701.31,200:711.26,220:721.20,240:731.15,260:741.09,275:751.04,300:765.95},140:{100:685.34,120:698.00,140:710.66,160:723.31,180:735.97,200:748.63,220:761.28,240:773.94,260:786.60,275:799.25,300:818.24},160:{100:701.21,120:715.68,140:730.14,160:744.61,180:759.07,200:773.54,220:788.00,240:802.47,260:816.93,275:831.40,300:853.09},190:{100:725.02,120:742.20,140:759.37,160:776.55,180:793.73,200:810.90,220:828.08,240:845.26,260:862.44,275:879.61,300:905.38}}
            };
            
            // MOTORIZADOS √ò58
            const ENROLLABLE_58_MOTOR = {
                "THECNIC BASIC": {90:{100:669.71,120:674.84,140:679.98,160:685.12,180:690.25,200:695.39,220:700.53,240:705.66,260:710.80,275:715.94,300:723.64},110:{100:683.34,120:689.62,140:695.90,160:702.17,180:708.45,200:714.73,220:721.01,240:725.29,260:733.57,275:739.85,300:749.26},140:{100:703.79,120:711.78,140:719.77,160:727.76,180:735.75,200:743.74,220:751.73,240:759.73,260:767.72,275:775.71,300:787.69},160:{100:717.42,120:726.56,140:735.69,160:744.82,180:753.95,200:763.09,220:772.22,240:781.35,260:790.48,275:799.61,300:813.31},190:{100:737.87,120:748.72,140:759.56,160:770.41,180:781.25,200:792.10,220:802.94,240:813.79,260:824.63,275:835.48,300:851.74},210:{100:751.51,120:763.49,140:775.48,160:787.47,180:799.45,200:798.04,220:823.43,240:835.41,260:847.40,275:859.38,300:877.36},230:{100:771.99,120:786.26,140:800.53,160:814.80,180:829.07,200:831.65,220:857.61,240:871.88,260:886.15,275:900.41,300:921.82}}
            };
            
            // ACCESORIOS
            const ACCESORIOS_ENROLLABLES_MANUAL = [
                {nombre:"Cadena Met√°lica Inox (metro lineal)", precio:4.35},
                {nombre:"Cadena Transparente (metro lineal)", precio:1.86},
                {nombre:"Anillo Cadena Met√°lica", precio:19.89},
                {nombre:"Anillo Cadena Transparente", precio:8.39},
                {nombre:"Escuadra 100mm Aluminio", precio:5.59},
                {nombre:"Escuadra 150mm Aluminio", precio:8.08},
                {nombre:"Escuadra 190mm Aluminio", precio:9.01},
                {nombre:"Escuadra Extensible 11-16cm", precio:7.44},
                {nombre:"Escuadra Extensible 16-24cm", precio:8.06},
                {nombre:"Soporte R√°pido", precio:11.19},
                {nombre:"Protecci√≥n Infantil Cadena", precio:3.10}
            ];
            
            const ACCESORIOS_ENROLLABLES_MOTOR = [
                {nombre:"Mando SITUO 1 PURE RTS", precio:103.00},
                {nombre:"Mando SITUO 5 PURE RTS", precio:150.00},
                {nombre:"Mando TELIS 16 PURE RTS", precio:391.00},
                {nombre:"Mando SITU√ì 1 IO PURE", precio:103.00},
                {nombre:"Mando SITU√ì 5 IO PURE", precio:150.00}
            ];


       const SISTEMAS = {
    "Estor a Cadena - Paquetto": {75:52.20, 100:57.38, 125:67.80, 150:77.19, 175:79.18, 200:88.61, 225:103.04, 250:107.97, 275:117.27, 300:126.66},
    "Estor a Cadena - Plegable": {75:54.01, 100:59.91, 125:69.94, 150:82.26, 175:89.06, 200:94.02, 225:108.11, 250:116.51, 275:128.41, 300:136.81},
    "Gu√≠a Manual 1 V√≠a - Convencional": {100:10.17, 125:12.86, 150:15.01, 175:16.74, 200:18.87, 225:20.95, 250:24.10, 275:26.42, 300:28.90},
    "Gu√≠a Manual 1 V√≠a - Onda Perfecta": {100:23.10, 125:29.03, 150:34.41, 175:39.38, 200:44.74, 225:50.06, 250:56.44, 275:61.99, 300:67.70},
    "Gu√≠a Profesional Manual - Convencional": {100:40.99, 150:55.77, 200:69.05, 250:85.07, 300:99.30},
    "Gu√≠a Profesional Manual - Onda Perfecta": {100:43.15, 150:58.72, 200:72.68, 250:89.54, 300:104.54},
    "Gu√≠a Profesional a Cord√≥n - Convencional": {100:52.53, 150:67.45, 200:81.01, 250:97.34, 300:111.90},
    "Gu√≠a Profesional a Cord√≥n - Onda Perfecta": {100:55.30, 150:70.99, 200:85.27, 250:102.46, 300:117.80},
    "Barra Gu√≠a Cuadrada - Convencional": {100:65.77, 150:79.68, 200:93.59, 250:124.26, 300:138.18},
    "Barra Gu√≠a Cuadrada - Onda Perfecta": {100:67.78, 150:82.70, 200:97.61, 250:129.29, 300:144.21},
    "Barra Gu√≠a Redonda 20mm - Convencional": {100:64.51, 150:78.17, 200:91.81, 250:121.89, 300:135.54},
    "Barra Gu√≠a Redonda 20mm - Onda Perfecta": {100:66.49, 150:81.12, 200:95.75, 250:126.82, 300:141.46},
    "Barra Gu√≠a Redonda 28mm - Convencional": {100:74.18, 150:85.98, 200:100.99, 250:134.08, 300:149.09},
    "Barra Gu√≠a Redonda 28mm - Onda Perfecta": {100:76.46, 150:93.28, 200:105.32, 250:139.51, 300:155.60},
    "Barra Forja Negra": "forja",
    "Barra Forja Blanca": "forja",
    "Barra √ìxido": "forja",
    "Barra Acero": "forja",
    "Barra Oro Viejo": "forja",
    "Barra Cuadrada con Anillas": "forja"
};

// Precios de barras seg√∫n nombre, di√°metro y medida
const PRECIOS_BARRAS = {
    "Barra Forja Negra": { "20": {150:66.96, 200:71.27, 250:95.72}, "28": {150:132.24, 200:144.75, 250:150.07} },
    "Barra Forja Blanca": { "20": {150:66.96, 200:71.27, 250:95.72}, "28": {150:132.24, 200:144.75, 250:150.07} },
    "Barra √ìxido": { "20": {150:66.96, 200:71.27, 250:95.72}, "28": {150:132.24, 200:144.75, 250:150.07} },
    "Barra Acero": { "20": {150:64.66, 200:69.02, 250:93.47}, "28": {150:134.49, 200:147.00, 250:152.33} },
    "Barra Oro Viejo": { "20": {150:76.36, 200:87.71, 250:99.68}, "28": {150:138.10, 200:150.61, 250:155.94} },
    "Barra Cuadrada con Anillas": { "√∫nico": {150:99.18, 200:108.32, 250:151.10, 300:176.21} }
};

        const CONFECCION = {
            "estor_paquetto": {100:60.08, 150:72.10, 200:84.12, 250:96.13, 300:120.17, 350:132.18},
            "estor_plegable": {100:72.10, 150:84.12, 200:96.13, 250:108.15, 300:126.17, 350:138.20},
            "cortina_onda_perfecta": {100:43.25, 150:55.28, 200:67.29, 250:79.31, 300:91.33, 350:103.34},
            "cortina_fruncida": {100:43.25, 150:55.28, 200:67.29, 250:79.31, 300:91.33, 350:103.34},
            "cortina_plana": {100:31.24, 150:43.25, 200:55.28, 250:60.08, 300:66.09, 350:78.11},
            "cortina_ollados": {100:31.24, 150:43.25, 200:55.28, 250:60.08, 300:66.09, 350:78.11},
            "cortina_triple_pliegue": {100:56.23, 150:71.86, 200:87.48, 250:103.11, 300:118.72, 350:134.34},
            "cortina_palas": {100:43.25, 150:55.28, 200:67.29, 250:79.31, 300:91.33, 350:103.34},
            "cortina_plana_doble": {100:31.24, 150:43.25, 200:55.28, 250:60.08, 300:66.09, 350:78.11},
            "cortina_plegones": {100:43.25, 150:55.28, 200:67.29, 250:79.31, 300:91.33, 350:103.34}
        };

        const TIPOS_NOMBRE = {
            "estor_paquetto": "Estor Paquetto",
            "estor_plegable": "Estor Plegable",
            "cortina_onda_perfecta": "Cortina Onda Perfecta",
            "cortina_fruncida": "Cortina Fruncida",
            "cortina_plana": "Cortina Plana",
            "cortina_ollados": "Cortina con Ollados",
            "cortina_triple_pliegue": "Cortina Triple Pliegue",
            "cortina_palas": "Cortina Palas",
            "cortina_plana_doble": "Cortina Plana Doble Tejido",
            "cortina_plegones": "Cortina Plegones"

        };

        let itemsActuales = [];
        let editandoItemId = null;
        let accesoriosEnrollablesSeleccionados = [];

        document.addEventListener('DOMContentLoaded', function() {
            cargarSistemas();
            cargarDashboard();
        });

        function cargarSistemas() {
    const select = document.getElementById('tipo-cortina');
    select.addEventListener('change', filtrarSistemasPorTipo);
}

function filtrarSistemasPorTipo() {
    const tipo = document.getElementById('tipo-cortina').value;
    const selectSistema = document.getElementById('sistema');
    selectSistema.innerHTML = '<option value="">Sin sistema</option>';
    
    let sistemasPermitidos = [];
    
    if (tipo === 'estor_paquetto' || tipo === 'estor_plegable') {
        sistemasPermitidos = Object.keys(SISTEMAS).filter(s => s.includes('Estor a Cadena'));
    } else if (tipo === 'cortina_ollados') {
        sistemasPermitidos = Object.keys(SISTEMAS).filter(s => SISTEMAS[s] === 'forja');
    } else if (tipo === 'cortina_onda_perfecta') {
        sistemasPermitidos = Object.keys(SISTEMAS).filter(s => s.includes('Onda Perfecta'));
    } else if (tipo === 'cortina_fruncida' || tipo === 'cortina_palas' || tipo === 'cortina_triple_pliegue' || 
               tipo === 'cortina_plana' || tipo === 'cortina_plana_doble' || tipo === 'cortina_plegones') {
        sistemasPermitidos = Object.keys(SISTEMAS).filter(s => s.includes('Convencional') || SISTEMAS[s] === 'forja');
    }
    
    sistemasPermitidos.forEach(s => {
        const option = document.createElement('option');
        option.value = s;
        option.textContent = s;
        selectSistema.appendChild(option);
    });
}

function mostrarOpcionesBarras() {
    const sistema = document.getElementById('sistema').value;
    const opcionesBarras = document.getElementById('opciones-barras');
    const diametroContainer = document.getElementById('diametro-container');
    const selectMedida = document.getElementById('medida-barra');
    
    if (SISTEMAS[sistema] === 'forja') {
        opcionesBarras.style.display = 'block';
        
        // Mostrar/ocultar di√°metro seg√∫n si es "Barra Cuadrada con Anillas"
        if (sistema === 'Barra Cuadrada con Anillas') {
            diametroContainer.style.display = 'none';
            document.getElementById('diametro-barra').value = '√∫nico';
            // A√±adir opci√≥n 300cm
            if (!selectMedida.querySelector('[value="300"]')) {
                const opt300 = document.createElement('option');
                opt300.value = '300';
                opt300.textContent = '300cm';
                selectMedida.appendChild(opt300);
            }
        } else {
            diametroContainer.style.display = 'block';
            document.getElementById('diametro-barra').value = '';
            // Quitar opci√≥n 300cm si existe
            const opt300 = selectMedida.querySelector('[value="300"]');
            if (opt300) opt300.remove();
        }
    } else {
        opcionesBarras.style.display = 'none';
        document.getElementById('diametro-barra').value = '';
        document.getElementById('medida-barra').value = '';
    }
}

    function calcularPrecioSistema(ancho, sistemaNombre) {
    if (!sistemaNombre) return 0;
    
    // Si es barra de forja
    if (SISTEMAS[sistemaNombre] === 'forja') {
        const diametro = document.getElementById('diametro-barra').value;
        const medida = parseInt(document.getElementById('medida-barra').value);
        
        if (!medida) {
            alert('Por favor selecciona el di√°metro y medida de la barra');
            return 0;
        }
        
        const preciosBarra = PRECIOS_BARRAS[sistemaNombre];
        if (!preciosBarra) return 0;
        
        const preciosPorDiametro = preciosBarra[diametro] || preciosBarra['√∫nico'];
        if (!preciosPorDiametro) return 0;
        
        const precio = preciosPorDiametro[medida] || 0;
        
        // Si el ancho supera 250cm, multiplicar por 2
        if (ancho > 250) {
            return precio * 2;
        }
        
        return precio;
    }
    
    // L√≥gica normal para otros sistemas
    const sistema = SISTEMAS[sistemaNombre];
    if (!sistema) return 0;
    
    const rangos = Object.keys(sistema).map(r => parseInt(r)).sort((a, b) => a - b);
    const rangoMaximo = rangos[rangos.length - 1];
    
    if (ancho > rangoMaximo) {
        const anchoMitad = ancho / 2;
        const rangoParaMitad = rangos.find(r => anchoMitad <= r) || rangoMaximo;
        return (sistema[rangoParaMitad] || 0) * 2;
    }
    
    const rangoAplicable = rangos.find(r => ancho <= r);
    return sistema[rangoAplicable || rangoMaximo] || 0;
}


        function buscarTejido() {
            const searchInput = document.getElementById('tejido-search');
            const searchResults = document.getElementById('search-results');
            const query = searchInput.value.toLowerCase();
            if (query.length === 0) {
                searchResults.classList.add('hidden');
                return;
            }
            const filtered = TEJIDOS.filter(t => t.nombre.toLowerCase().includes(query));
            if (filtered.length === 0) {
                searchResults.innerHTML = '<div class="search-result-item">No se encontraron tejidos</div>';
                searchResults.classList.remove('hidden');
                return;
            }
            searchResults.innerHTML = filtered.map(t => `
                <div class="search-result-item" onclick="seleccionarTejido('${t.nombre}')">
                    <strong>${t.nombre}</strong><br>
                    <small style="color: #64748b;">${t.precio}‚Ç¨/ml - ${t.composicion}</small>
                </div>
            `).join('');
            searchResults.classList.remove('hidden');
        }

        function seleccionarTejido(nombre) {
            document.getElementById('tejido-search').value = nombre;
            document.getElementById('tejido').value = nombre;
            document.getElementById('search-results').classList.add('hidden');
        }

        document.addEventListener('click', function(e) {
            const searchBox = document.querySelector('.search-box');
            if (searchBox && !searchBox.contains(e.target)) {
                const results = document.getElementById('search-results');
                if (results) {
                    results.classList.add('hidden');
                }
            }
        });

        function mostrarVista(vista) {
            document.getElementById('dashboard-view').classList.add('hidden');
            document.getElementById('nuevo-view').classList.add('hidden');
            document.getElementById('detalle-view').classList.add('hidden');
            if (vista === 'dashboard') {
                document.getElementById('dashboard-view').classList.remove('hidden');
                cargarDashboard();
            } else if (vista === 'nuevo') {
                document.getElementById('nuevo-view').classList.remove('hidden');
                limpiarFormulario();
            } else if (vista === 'detalle') {
                document.getElementById('detalle-view').classList.remove('hidden');
            }
        }

        function agregarItem() {
    const tipo = document.getElementById('tipo-cortina').value;
    const ancho = parseFloat(document.getElementById('ancho').value);
    const alto = parseFloat(document.getElementById('alto').value);
    const tejidoNombre = document.getElementById('tejido').value;
    const sistemaNombre = document.getElementById('sistema').value;  // ‚Üê FALTABA ESTO
    
    let sistemaNombreCompleto = sistemaNombre || 'Sin sistema';

    // Si el sistema existe y es tipo forja
    if (sistemaNombre && SISTEMAS[sistemaNombre] === 'forja') {
        const diametro = document.getElementById('diametro-barra').value;
        const medida = document.getElementById('medida-barra').value;

        if (sistemaNombre !== 'Barra Cuadrada con Anillas') {
            sistemaNombreCompleto = `${sistemaNombre} ${diametro}mm - ${medida}cm`;
        } else {
            sistemaNombreCompleto = `${sistemaNombre} - ${medida}cm`;
        }
    }

    const dosPiezas = document.getElementById('dos-piezas').checked;

    if (!tipo || !ancho || !alto || !tejidoNombre) {
        alert('Por favor completa todos los campos obligatorios');
        return;
    }

    const tejido = TEJIDOS.find(t => t.nombre === tejidoNombre);
    const anchoParaTejido = dosPiezas ? ancho / 2 : ancho;

    let tejidoMetros = 0;

    if (tipo === 'estor_paquetto' || tipo === 'estor_plegable')
        tejidoMetros = (anchoParaTejido + 40) / 100;
    else if (tipo === 'cortina_onda_perfecta')
        tejidoMetros = (anchoParaTejido * 2.4) / 100;
    else if (tipo === 'cortina_ollados')
        tejidoMetros = (anchoParaTejido * 2.2) / 100;
    else if (tipo === 'cortina_plana')
        tejidoMetros = (anchoParaTejido * 1.4) / 100;
    else if (tipo === 'cortina_fruncida')
        tejidoMetros = (anchoParaTejido * 2.5) / 100;
    else if (tipo === 'cortina_triple_pliegue')
        tejidoMetros = (anchoParaTejido * 2.7) / 100;
    else if (tipo === 'cortina_palas')
        tejidoMetros = (anchoParaTejido * 2.6) / 100;
    else if (tipo === 'cortina_plana_doble')
        tejidoMetros = (anchoParaTejido * 2) / 100;
    else if (tipo === 'cortina_plegones')
        tejidoMetros = (anchoParaTejido * 2.6) / 100;

    tejidoMetros = Math.round(tejidoMetros * 100) / 100;

    const precioTejido = tejidoMetros * tejido.precio;
    const confeccion = CONFECCION[tipo];

    let precioConfeccion = 0;

    if (anchoParaTejido <= 100) precioConfeccion = confeccion[100];
    else if (anchoParaTejido <= 150) precioConfeccion = confeccion[150];
    else if (anchoParaTejido <= 200) precioConfeccion = confeccion[200];
    else if (anchoParaTejido <= 250) precioConfeccion = confeccion[250];
    else if (anchoParaTejido <= 300) precioConfeccion = confeccion[300];
    else precioConfeccion = confeccion[350] || confeccion[300];

    const precioSistema = calcularPrecioSistema(ancho, sistemaNombre);
    const precioTejidoFinal = dosPiezas ? precioTejido * 2 : precioTejido;
    const precioConfeccionFinal = dosPiezas ? precioConfeccion * 2 : precioConfeccion;

    let precioOllados = 0;

    if (tipo === 'cortina_ollados') {
        const tejidoCm = ancho * 2.2; 
        let numOllados = Math.floor(tejidoCm / 15);

        if (numOllados % 2 === 0) numOllados += 2;
        else numOllados += 3;

        precioOllados = numOllados * 5.5;
    }

    const precioInstalacion = document.getElementById('incluir-instalacion').checked ? 50 : 0;

    const precioTotal = 
        precioTejidoFinal + 
        precioConfeccionFinal + 
        precioSistema + 
        precioOllados + 
        precioInstalacion;

    const item = {
        id: editandoItemId || Date.now(),
        tipo,
        descripcion: `${TIPOS_NOMBRE[tipo]} - ${tejidoNombre}${dosPiezas ? ' (2 piezas)' : ''}`,
        ancho, alto,
        tejido_nombre: tejidoNombre,
        sistema_nombre: sistemaNombreCompleto,
        precio_total: precioTotal,
        dos_piezas: dosPiezas
    };

    if (editandoItemId) {
        const index = itemsActuales.findIndex(i => i.id === editandoItemId);
        itemsActuales[index] = item;
        editandoItemId = null;
        document.getElementById('btn-texto').textContent = '‚ûï Calcular y Agregar al Presupuesto';
    } else {
        itemsActuales.push(item);
    }

    actualizarItems();
    actualizarResumen();

    document.getElementById('tipo-cortina').value = '';
    document.getElementById('ancho').value = '';
    document.getElementById('alto').value = '';
    document.getElementById('tejido').value = '';
    document.getElementById('tejido-search').value = '';
    document.getElementById('sistema').value = '';
    document.getElementById('dos-piezas').checked = false;
}

        function eliminarItem(id) {
            itemsActuales = itemsActuales.filter(item => item.id !== id);
            actualizarItems();
            actualizarResumen();
        }
        
        function editarItem(id) {
    const item = itemsActuales.find(i => i.id === id);
    if (!item) return;
    
    document.getElementById('tipo-cortina').value = item.tipo;
    document.getElementById('ancho').value = item.ancho;
    document.getElementById('alto').value = item.alto;
    document.getElementById('tejido').value = item.tejido_nombre;
    document.getElementById('tejido-search').value = item.tejido_nombre;
    document.getElementById('sistema').value = item.sistema_nombre === 'Sin sistema' ? '' : item.sistema_nombre;
    document.getElementById('dos-piezas').checked = item.dos_piezas;
    document.getElementById('btn-texto').textContent = '‚úèÔ∏è Actualizar Item';
    
    editandoItemId = id;
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

        function actualizarItems() {
            const lista = document.getElementById('items-list');
            const card = document.getElementById('items-card');
            if (itemsActuales.length === 0) {
                card.style.display = 'none';
                return;
            }
            card.style.display = 'block';
            lista.innerHTML = '';
            itemsActuales.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'item';
                div.innerHTML = `
                    <div class="item-info">
                        <h4>#${index + 1} - ${item.descripcion}</h4>
                        <p>Medidas: ${item.ancho}cm x ${item.alto}cm | Sistema: ${item.sistema_nombre}</p>
                    </div>
                   <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <div class="item-price">${item.precio_total.toFixed(2)}‚Ç¨</div>
                      <button class="btn" onclick="editarItem(${item.id})" style="background: #f59e0b; color: white; padding: 0.5rem 1rem;">‚úèÔ∏è Editar</button>
                      <button class="btn btn-danger" onclick="eliminarItem(${item.id})">üóëÔ∏è</button>
                    </div>
                `;
                lista.appendChild(div);
            });
        }

      function actualizarResumen() {
    const totalItems = itemsActuales.length;
    const subtotal = itemsActuales.reduce((sum, item) => sum + item.precio_total, 0);
    const incluirInstalacion = document.getElementById('incluir-instalacion').checked;
    const subtotalConInstalacion = subtotal;
    const iva = subtotalConInstalacion * 0.21;
    const total = subtotalConInstalacion + iva;

    document.getElementById('total-items').textContent = totalItems;
    document.getElementById('subtotal').textContent = subtotalConInstalacion.toFixed(2) + '‚Ç¨';
    document.getElementById('iva').textContent = iva.toFixed(2) + '‚Ç¨';
    document.getElementById('total').textContent = total.toFixed(2) + '‚Ç¨';
}

        function guardarPresupuesto() {
            const nombre = document.getElementById('cliente-nombre').value;
            if (!nombre) {
                alert('Por favor ingresa el nombre del cliente');
                return;
            }
            if (itemsActuales.length === 0) {
                alert('Agrega al menos un item al presupuesto');
                return;
            }

           const subtotal = itemsActuales.reduce((sum, item) => sum + item.precio_total, 0);
           const total = subtotal * 1.21;

            const presupuesto = {
    id: Date.now().toString(),
    numero: String(JSON.parse(localStorage.getItem('presupuestos') || '[]').length + 1).padStart(4, '0'),
    cliente_nombre: nombre,
    cliente_telefono: document.getElementById('cliente-telefono').value,
    cliente_email: document.getElementById('cliente-email').value,
    cliente_direccion: document.getElementById('cliente-direccion').value,
    fecha: new Date().toISOString().split('T')[0],
    items: itemsActuales,
    total_sin_iva: subtotal,
    total_con_iva: total,
    estado: 'borrador',
    notas: document.getElementById('notas').value
};

            let presupuestos = JSON.parse(localStorage.getItem('presupuestos') || '[]');
            presupuestos.push(presupuesto);
            localStorage.setItem('presupuestos', JSON.stringify(presupuestos));
            alert('‚úÖ Presupuesto guardado correctamente');
            mostrarVista('dashboard');
        }

        function cargarDashboard() {
            const presupuestos = JSON.parse(localStorage.getItem('presupuestos') || '[]');
            document.getElementById('total-presupuestos').textContent = presupuestos.length;
            const totalImporte = presupuestos.reduce((sum, p) => sum + p.total_con_iva, 0);
            document.getElementById('total-importe').textContent = totalImporte.toFixed(0) + '‚Ç¨';
            const esteMes = presupuestos.filter(p => {
                const fecha = new Date(p.fecha);
                const ahora = new Date();
                return fecha.getMonth() === ahora.getMonth() && fecha.getFullYear() === ahora.getFullYear();
            }).length;
            document.getElementById('total-mes').textContent = esteMes;

            const tbody = document.querySelector('#tabla-presupuestos tbody');
            tbody.innerHTML = '';
            if (presupuestos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 3rem; color: #64748b;">No hay presupuestos. ¬°Crea el primero!</td></tr>';
                return;
            }

            presupuestos.reverse().forEach(p => {
                const tr = document.createElement('tr');
                tr.onclick = () => verDetalle(p.id);
                tr.innerHTML = `
                    <td>${p.numero}</td>
                    <td>${p.cliente_nombre}</td>
                    <td>${new Date(p.fecha).toLocaleDateString('es-ES')}</td>
                    <td>${p.items.length}</td>
                    <td style="text-align: right; font-weight: bold;">${p.total_con_iva.toFixed(2)}‚Ç¨</td>
                    <td style="text-align: center;">
                    <button class="btn btn-danger" onclick="eliminarPresupuesto('${p.id}', event)" style="padding: 0.5rem 1rem;">üóëÔ∏è Eliminar</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function eliminarPresupuesto(id, event) {
    event.stopPropagation();
    if (confirm('¬øEst√°s seguro de eliminar este presupuesto?')) {
        let presupuestos = JSON.parse(localStorage.getItem('presupuestos') || '[]');
        presupuestos = presupuestos.filter(p => p.id !== id);
        localStorage.setItem('presupuestos', JSON.stringify(presupuestos));
        cargarDashboard();
    }
}

        function verDetalle(id) {
            const presupuestos = JSON.parse(localStorage.getItem('presupuestos') || '[]');
            const p = presupuestos.find(pr => pr.id === id);
            if (!p) return;

           
            document.getElementById('detalle-content').innerHTML = `
                <div class="aviso-orientativo">
                    <strong>‚ö†Ô∏è PRESUPUESTO ORIENTATIVO</strong>
                    <p>Precios sujetos a confirmaci√≥n tras toma de medidas definitiva.</p>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 1rem; padding: 1rem; border-bottom: 2px solid #e2e8f0;">
                    <div>
                        <h2 style="color: #2563eb;">CANOTEX</h2>
                        <p style="color: #64748b; font-size: 0.75rem;">Tel: 973235776 | info@canotex.es</p>
                    </div>
                    <div style="text-align: right;">
                        <h2 style="color: #2563eb;">PRESUPUESTO</h2>
                        <p style="font-size: 0.75rem;">N¬∫: ${p.numero}</p>
                        <p style="font-size: 0.75rem;">Fecha: ${new Date(p.fecha).toLocaleDateString('es-ES')}</p>
                    </div>
                </div>
                ${p.cliente_nombre ? `
                <div style="background: #f8fafc; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <h3 style="font-size: 0.75rem; color: #64748b;">CLIENTE</h3>
                    <p style="font-weight: 600;">${p.cliente_nombre}</p>
                    ${p.cliente_telefono ? `<p style="font-size: 0.875rem;">${p.cliente_telefono}</p>` : ''}
                </div>
                ` : ''}
                <h3 style="margin-bottom: 1rem;">Detalle del Presupuesto</h3>
                <table class="tabla">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Descripci√≥n</th>
                            <th>Medidas</th>
                            <th>Sistema</th>
                            <th style="text-align: right;">Precio</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${p.items.map((item, i) => `
                            <tr>
                                <td>${i + 1}</td>
                                <td>${item.descripcion}</td>
                                <td>${item.ancho} x ${item.alto} cm</td>
                                <td>${item.sistema_nombre || 'Sin sistema'}</td>
                                <td style="text-align: right; font-weight: 600;">${item.precio_total.toFixed(2)}‚Ç¨</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                <div style="display: flex; justify-content: flex-end; margin-top: 1rem;">
                    <div style="width: 18rem;">
                       <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #e2e8f0;">
                            <span>Subtotal:</span>
                            <strong>${p.total_sin_iva.toFixed(2)}‚Ç¨</strong>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #e2e8f0;">
                            <span>IVA (21%):</span>
                            <strong>${(p.total_sin_iva * 0.21).toFixed(2)}‚Ç¨</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 1rem; background: #dbeafe; margin-top: 0.5rem; border-radius: 8px;">
                            <span style="font-weight: bold;">TOTAL:</span>
                            <span style="font-size: 1.5rem; font-weight: bold; color: #2563eb;">${p.total_con_iva.toFixed(2)}‚Ç¨</span>
                        </div>
                    </div>
                </div>
                ${p.notas ? `<div style="margin-top: 1rem; padding: 1rem; background: #fef3c7; border-radius: 8px;"><h4>Notas:</h4><p>${p.notas}</p></div>` : ''}
                <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #e2e8f0; text-align: center; font-size: 0.75rem; color: #64748b;">
                    <p>Presupuesto v√°lido por 30 d√≠as</p>
                    <p>Canotex Textil S.L. - C/ Pened√©s, 87 - 25005 Lleida</p>
                </div>
            `;
            mostrarVista('detalle');
        }

        function limpiarFormulario() {
            document.getElementById('cliente-nombre').value = '';
            document.getElementById('cliente-telefono').value = '';
            document.getElementById('cliente-email').value = '';
            document.getElementById('cliente-direccion').value = '';
            document.getElementById('notas').value = '';
            document.getElementById('incluir-instalacion').checked = false;
            document.getElementById('btn-texto').textContent = '‚ûï Calcular y Agregar al Presupuesto';
            itemsActuales = [];
            actualizarItems();
            actualizarResumen();
        }


                        // ========== NUEVAS FUNCIONES ENROLLABLES ==========
            
            function cambiarCategoria(cat) {
                const btnTrad = document.getElementById('btn-tradicionales');
                const btnTec = document.getElementById('btn-tecnicas');
                const formTrad = document.getElementById('form-tradicionales');
                const formTec = document.getElementById('form-tecnicas');
                
                if (cat === 'tradicionales') {
                    btnTrad.className = 'btn btn-primary';
                    btnTec.className = 'btn btn-secondary';
                    formTrad.style.display = 'block';
                    formTec.style.display = 'none';
                } else {
                    btnTrad.className = 'btn btn-secondary';
                    btnTec.className = 'btn btn-primary';
                    formTrad.style.display = 'none';
                    formTec.style.display = 'block';
                    cargarAccesoriosEnrollables();
                }
            }
            
            function cambiarTipoTecnica(tipo) {
                const btnE = document.getElementById('btn-enrollable');
                const btnV = document.getElementById('btn-vertical');
                const formE = document.getElementById('form-enrollable');
                const formV = document.getElementById('form-vertical');
                
                if (tipo === 'enrollable') {
                    btnE.className = 'btn btn-primary';
                    btnV.className = 'btn btn-secondary';
                    formE.style.display = 'block';
                    formV.style.display = 'none';
                } else {
                    btnE.className = 'btn btn-secondary';
                    btnV.className = 'btn btn-primary';
                    formE.style.display = 'none';
                    formV.style.display = 'block';
                }
            }
            
            function actualizarDiametrosDisponibles() {
                const motorizado = document.getElementById('motorizado-enrollable').checked;
                const selectDiametro = document.getElementById('diametro-enrollable');
                
                selectDiametro.innerHTML = '<option value="">Selecciona...</option>';
                
                if (motorizado) {
                    selectDiametro.innerHTML += '<option value="43">Tubo √ò43mm (Motor)</option>';
                    selectDiametro.innerHTML += '<option value="58">Tubo √ò58mm (Motor)</option>';
                } else {
                    selectDiametro.innerHTML += '<option value="32">Tubo √ò32mm (Manual)</option>';
                    selectDiametro.innerHTML += '<option value="43">Tubo √ò43mm (Manual)</option>';
                    selectDiametro.innerHTML += '<option value="58">Tubo √ò58mm (Manual)</option>';
                }
                
                cargarAccesoriosEnrollables();
                actualizarPrecioEnrollable();
            }
            
            function cargarAccesoriosEnrollables() {
                const motorizado = document.getElementById('motorizado-enrollable').checked;
                const lista = document.getElementById('accesorios-enrollable-list');
                const accesorios = motorizado ? ACCESORIOS_ENROLLABLES_MOTOR : ACCESORIOS_ENROLLABLES_MANUAL;
                
                lista.innerHTML = accesorios.map((acc, idx) => `
                    <div class="checkbox-container" style="margin: 0.5rem 0; padding: 0.75rem; background: white;">
                        <input type="checkbox" id="acc-enr-${idx}" onchange="toggleAccesorioEnrollable(${idx})">
                        <label for="acc-enr-${idx}" style="flex: 1;">${acc.nombre}</label>
                        <span style="font-weight: bold; color: #22c55e;">${acc.precio.toFixed(2)}‚Ç¨</span>
                    </div>
                `).join('');
                
                accesoriosEnrollablesSeleccionados = [];
            }
            
            function toggleAccesorioEnrollable(idx) {
                const motorizado = document.getElementById('motorizado-enrollable').checked;
                const accesorios = motorizado ? ACCESORIOS_ENROLLABLES_MOTOR : ACCESORIOS_ENROLLABLES_MANUAL;
                const checkbox = document.getElementById(`acc-enr-${idx}`);
                
                if (checkbox.checked) {
                    accesoriosEnrollablesSeleccionados.push(accesorios[idx]);
                } else {
                    accesoriosEnrollablesSeleccionados = accesoriosEnrollablesSeleccionados.filter(a => a.nombre !== accesorios[idx].nombre);
                }
                
                actualizarPrecioEnrollable();
            }
            
            function actualizarPrecioEnrollable() {
                const tejido = document.getElementById('tejido-enrollable').value;
                const ancho = parseInt(document.getElementById('ancho-enrollable').value);
                const alto = parseInt(document.getElementById('alto-enrollable').value);
                const diametro = document.getElementById('diametro-enrollable').value;
                const motorizado = document.getElementById('motorizado-enrollable').checked;
                const instalacion = document.getElementById('instalacion-enrollable').checked;
                
                if (!tejido || !ancho || !alto || !diametro) {
                    document.getElementById('precio-enrollable-preview').textContent = '0.00‚Ç¨';
                    return;
                }
                
                let tarifas;
                if (motorizado) {
                    tarifas = diametro === "43" ? ENROLLABLE_43_MOTOR : ENROLLABLE_58_MOTOR;
                } else {
                    tarifas = diametro === "32" ? ENROLLABLE_32_MANUAL : (diametro === "43" ? ENROLLABLE_43_MANUAL : ENROLLABLE_58_MANUAL);
                }
                
                const preciosPorTejido = tarifas[tejido] || tarifas["THECNIC BASIC"];
                if (!preciosPorTejido) {
                    document.getElementById('precio-enrollable-preview').textContent = 'N/A';
                    return;
                }
                
                const anchosDisponibles = Object.keys(preciosPorTejido).map(a => parseInt(a)).sort((a,b) => a - b);
                const anchoAplicable = anchosDisponibles.find(a => ancho <= a) || anchosDisponibles[anchosDisponibles.length - 1];
                
                const preciosPorAncho = preciosPorTejido[anchoAplicable];
                if (!preciosPorAncho) {
                    document.getElementById('precio-enrollable-preview').textContent = 'N/A';
                    return;
                }
                
                const altosDisponibles = Object.keys(preciosPorAncho).map(h => parseInt(h)).sort((a,b) => a - b);
                const altoAplicable = altosDisponibles.find(h => alto <= h) || altosDisponibles[altosDisponibles.length - 1];
                
                let precioBase = preciosPorAncho[altoAplicable] || 0;
                const precioAccesorios = accesoriosEnrollablesSeleccionados.reduce((sum, acc) => sum + acc.precio, 0);
                const precioInstalacion = instalacion ? 50 : 0;
                const precioTotal = precioBase + precioAccesorios + precioInstalacion;
                
                document.getElementById('precio-enrollable-preview').textContent = precioTotal.toFixed(2) + '‚Ç¨';
            }
            
            function agregarItemEnrollable() {
                const tejido = document.getElementById('tejido-enrollable').value;
                const ancho = parseInt(document.getElementById('ancho-enrollable').value);
                const alto = parseInt(document.getElementById('alto-enrollable').value);
                const diametro = document.getElementById('diametro-enrollable').value;
                const motorizado = document.getElementById('motorizado-enrollable').checked;
                const mando = document.getElementById('mando-enrollable').value;
                const direccion = document.getElementById('direccion-enrollable').value;
                const instalacion = document.getElementById('instalacion-enrollable').checked;
                
                if (!tejido || !ancho || !alto || !diametro) {
                    alert('Completa todos los campos obligatorios');
                    return;
                }
                
                let tarifas;
                if (motorizado) {
                    tarifas = diametro === "43" ? ENROLLABLE_43_MOTOR : ENROLLABLE_58_MOTOR;
                } else {
                    tarifas = diametro === "32" ? ENROLLABLE_32_MANUAL : (diametro === "43" ? ENROLLABLE_43_MANUAL : ENROLLABLE_58_MANUAL);
                }
                
                const preciosPorTejido = tarifas[tejido] || tarifas["THECNIC BASIC"];
                const anchosDisponibles = Object.keys(preciosPorTejido).map(a => parseInt(a)).sort((a,b) => a - b);
                const anchoAplicable = anchosDisponibles.find(a => ancho <= a) || anchosDisponibles[anchosDisponibles.length - 1];
                const preciosPorAncho = preciosPorTejido[anchoAplicable];
                const altosDisponibles = Object.keys(preciosPorAncho).map(h => parseInt(h)).sort((a,b) => a - b);
                const altoAplicable = altosDisponibles.find(h => alto <= h) || altosDisponibles[altosDisponibles.length - 1];
                
                let precioBase = preciosPorAncho[altoAplicable] || 0;
                const precioAccesorios = accesoriosEnrollablesSeleccionados.reduce((sum, acc) => sum + acc.precio, 0);
                const precioInstalacion = instalacion ? 50 : 0;
                const precioTotal = precioBase + precioAccesorios + precioInstalacion;
                
                const accesoriosTexto = accesoriosEnrollablesSeleccionados.length > 0 
                    ? ' + ' + accesoriosEnrollablesSeleccionados.map(a => a.nombre).join(', ')
                    : '';
                
                const item = {
                    id: Date.now(),
                    tipo: 'enrollable_tecnico',
                    descripcion: `Enrollable ${tejido} √ò${diametro}mm ${motorizado?'MOTOR':'MANUAL'} - ${mando}/${direccion}${accesoriosTexto}`,
                    ancho, alto,
                    tejido_nombre: tejido,
                    sistema_nombre: `Enrollable √ò${diametro}mm ${motorizado?'MOTORIZADO':'MANUAL'}`,
                    precio_total: precioTotal,
                    dos_piezas: false,
                    incluye_instalacion: instalacion
                };
                
                itemsActuales.push(item);
                actualizarItems();
                actualizarResumen();
                
                // Limpiar
                document.getElementById('tejido-enrollable').value = '';
                document.getElementById('ancho-enrollable').value = '';
                document.getElementById('alto-enrollable').value = '';
                document.getElementById('diametro-enrollable').value = '';
                document.getElementById('motorizado-enrollable').checked = false;
                document.getElementById('instalacion-enrollable').checked = false;
                accesoriosEnrollablesSeleccionados = [];
                actualizarDiametrosDisponibles();
                document.getElementById('precio-enrollable-preview').textContent = '0.00‚Ç¨';
                document.addEventListener('DOMContentLoaded', () => {
    // Asegura que el form enrollable comienza oculto
    const formEnr = document.getElementById('form-enrollable');
    if (formEnr) formEnr.style.display = 'none';

    // Carga di√°metros y accesorios iniciales
    if (typeof actualizarDiametrosDisponibles === 'function') {
        actualizarDiametrosDisponibles();
    }
});

            }
    </script>
</body>
</html>
